# 自定义组件

## 自定义模块

[让Qt Creator更懂我们的自定义模块](https://zhuanlan.zhihu.com/p/139517014)

[qml-自定义quick模块](https://www.jianshu.com/p/163666976f96)

[QML自定义组件实现（扩展插件）](https://blog.csdn.net/w_419675647/article/details/104859365)

[QML插件扩展](https://blog.csdn.net/yizhou2010/article/details/87620776)

[玩转Qml(10)-自定义Quick模块](https://blog.csdn.net/D759378563/article/details/111872181)

### 基本概念

**qmldir:**
用于组织自定义的QML插件。

**.qmltypes：** qml插件的解释文件，用于QtCreator语法高亮。可通过Qt提供的工具_qmlplugindump_自动生成。

**QML_IMPORT_PATH:** 导入插件路径，以支持插件的语法高亮。个人理解是如果纯QML文件的扩展，没有封装到C++中，则直接导入路径，即可支持语法高亮，如果有C++封装，则需要通过.qmltypes支持高亮。

**addImportPath:** 添加import寻址目录，c++代码里添加，没有前两项，只是QtCreator不能高亮，没有这种，则插件无法使用。

### 目的

将自己写的可通用的qml组件打包成dll文件，供其他项目使用。通过生成qmltypes文件实现在qt creator中正常识别，能够自动补全。项目不需要任何多余操作，直接import即可使用。

### 新建项目

![新建项目](C:/Users/Win10/Desktop/Injection/README/READMEImage/新建项目.png)

![新建项目](C:/Users/Win10/Desktop/Injection/README/READMEImage/新建项目1.png)

![新建项目](C:/Users/Win10/Desktop/Injection/README/READMEImage/新建项目2.png)

![新建项目](C:/Users/Win10/Desktop/Injection/README/READMEImage/新建项目3.png)

### 编写组件

在项目中编写自定义的QML组件，可以参考Qt官方的定制教程[Customizing Qt Quick Controls](https://doc.qt.io/qt-5/qtquickcontrols2-customize.html#customizing-combobox)，新建qrc资源管理文件，将组件的QML文件包含在qrc文件中（_为的是导出dll插件时，不用带上qml源码_）。借鉴如上教程中，对Button的定制代码,新建InoButton.qml。

```javascript
import QtQuick 2.12
import QtQuick.Controls 2.12
Rectangle {
    id: root
    property alias textItem: t      //导出Text实例，方便外部直接修改
    property alias text: t.text     //导出文本
    property alias textColor: t.color   //导出文本颜色
    property alias containsMouse: area.containsMouse    //导出鼠标悬浮
    property alias containsPress: area.containsPress    //导出鼠标按下
    signal clicked();               //自定义点击信号
    color: "transparent"
    Text {
        id: t
        //默认坐标居中
        anchors.centerIn: parent
        //默认文字对齐方式为水平和垂直居中
        verticalAlignment: Text.AlignVCenter
        horizontalAlignment: Text.AlignHCenter
        //默认宽度为parent的宽度，这样字太长超出范围时自动显示省略号
        width: parent.width
        elide: Text.ElideRight
    }

    MouseArea {
        id: area
        anchors.fill: parent;
        hoverEnabled: parent.enabled;
        onClicked: root.clicked();  //点击时触发自定义点击信号
        cursorShape: Qt.PointingHandCursor  //悬浮或点击时的鼠标样式
    }
}

```

**注册组件**

在插件类的registerTypes成员函数中(`inocontrols_plugin.cpp`)注册自定义组件插件。

![新建项目](C:/Users/Win10/Desktop/Injection/README/READMEImage/新建项目4.png)

**编写qmldir**

```bash
#模块名
module InoControls
#构建项目生成的dll文件名
plugin InoControls

#依赖的模块
depends QtQuick 2.7
depends QtQuick.Controls 2.3

#项目中继承自QQmlExtensionPlugin的类名
classname InoControlsPlugin
#要生成的类型解释文件的名字
typeinfo plugin.qmltypes
```

**Release下构建**

在Release下构建组件项目，生成.dll文件（Windows下）。

### 生成qmltypes文件

_.qmltypes_可以在qtcreator中对组件进行提示和语法高亮。Qt其实自带了一个工具，位于bin目录里的qmlplugindump，是个命令行工具，可以用来生成_.qmltypes_文件。生成_.qmltypes_文件过程也是探索了蛮久的，按照如下步骤进行：

1. 将Release模式下生产的*.dll*拷贝到项目目录下，如图所示：

   ![qml](C:/Users/Win10/Desktop/Injection/README/READMEImage/qmltypes.png)

2. 命令行下执行

   `/c/Qt/Qt5.14.0/5.14.2/mingw73_64/bin/qmlplugindump.exe InoControls 1.0 ../../Injection/ -nonrelocatable > ./plugin.qmltypes`

   `/c/Qt/Qt5.14.0/5.14.2/mingw73_64/bin/qmlplugindump.exe` : qmlplugindump工具

   `InoControls` : 组件名字

   `1.0` : 版本号，导入的时候 `import InoControls 1.0`

   `../../Injection/` : 包含了工程文件夹的目录

   `-nonrelocatable` ： 添加导出组件的位置

   `>` : 生成输出位置，可以用`-output`

   `./plugin.qmltypes` : 当前目录下的plugin.qmltypes

   ![types](C:/Users/Win10/Desktop/Injection/README/READMEImage/生成qmltypes文件4.png)

   **注意**

   不加命令`-nonrelocatable` 生成的`.qmltypes`中导出组件没有路径，后面还是会找不到组件报错。

   没有加`-nonrelocatable`生成的`.qmltypes`

   ![types](C:/Users/Win10/Desktop/Injection/README/READMEImage/生成qmltypes文件5.png)

   加`-nonrelocatable`生成的`.qmltypes`

   ![types](C:/Users/Win10/Desktop/Injection/README/READMEImage/生成qmltypes文件6.png)

   下面也有生产错误的报错截图：

   ![types](C:/Users/Win10/Desktop/Injection/README/READMEImage/生成qmltypes文件.png)

3. 添加到qt安装目录下

   `C:\Qt\Qt5.14.0\5.14.2\mingw73_64\qml\`下新建跟组件工程名一样的文件夹，放入`.dll、.qmltypes 、qmldir`文件即可，那么在别的工程中，就可以导入你写的自定义组件，并且有代码提示和语法高亮。

   ![路径](C:/Users/Win10/Desktop/Injection/README/READMEImage/路径.png)